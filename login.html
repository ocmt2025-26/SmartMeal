<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SmartMeal - Login</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<header class="site-header">
<div class="brand">
<div class="logo-box">
    <img src="https://raw.githubusercontent.com/ocmt2025-26/SmartMeal/main/college.png.jpeg" 
         alt="College Logo" class="header-logo">
</div>
<div>
<h1>SmartMeal</h1>
<p class="subtitle">Login Page</p>
</div>
</div>
<nav class="nav">
<a href="index.html">Home</a>
<a href="menu.html">Menu</a>
<a href="cart.html">Cart (<span id="cartCount">0</span>)</a>
<a href="profile.html" id="profileLink">Account</a>
</nav>
</header>

<main class="container fade-in">
<h2>Login / Register</h2>
<form id="loginForm" onsubmit="event.preventDefault(); doLoginFirebase();">
<label>Name</label>
<input type="text" id="name" placeholder="Your Name" required>
<label>Email</label>
<input type="email" id="email" placeholder="Your College Email" required>
<label>Password</label>
<input type="password" id="password" placeholder="Password" required>
<label>Phone</label>
<input type="text" id="phone" placeholder="Phone Number">
<button class="btn primary" type="submit">Login</button>
<p id="loginError" style="color:red;"></p>
</form>
</main>

<footer class="site-footer">
<div>Contact: cafeteria@ocmt.edu.om</div>
<div>© SmartMeal • Terms & Conditions</div>
</footer>

<script type="module">
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const db = getDatabase();
const ADMIN_CREDENTIALS = { email: "admin@ocmt.edu.om", password: "admin123" };

window.doLoginFirebase = async function() {
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const errorEl = document.getElementById('loginError');
    errorEl.innerText = '';

    if(!email || !password){ errorEl.innerText = 'Email and password required'; return; }

    if(email === ADMIN_CREDENTIALS.email && password === ADMIN_CREDENTIALS.password){
        const adminData = { name:'Admin', email, phone, isAdmin:true };
        localStorage.setItem('smartmeal_user', JSON.stringify(adminData));
        location.href = 'admin.html';
        return;
    }

    const userRef = ref(db, 'users/' + btoa(email));
    try {
        const snapshot = await get(userRef);
        if(snapshot.exists()){
            const user = snapshot.val();
            if(user.password === password){
                localStorage.setItem('smartmeal_user', JSON.stringify({ name:user.name, email:user.email, phone:user.phone }));
                location.href = 'profile.html';
            } else {
                errorEl.innerText = 'Incorrect password';
            }
        } else {
            await set(userRef, { name, email, phone, password });
            localStorage.setItem('smartmeal_user', JSON.stringify({ name, email, phone }));
            location.href = 'profile.html';
        }
    } catch(err){
        console.error(err);
        errorEl.innerText = 'Error connecting to database';
    }
};
</script>
</body>
</html>
